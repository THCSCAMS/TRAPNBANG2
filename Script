local UI = script.Parent
local KSYS = UI.KeySystem
local LSYS = UI.Loading
local LIBRARY = UI.Library
local playerUser = game.Players.LocalPlayer.Name:upper()

local UBOX = KSYS.User
local KBOX = KSYS.Key
local LOGIN = KSYS.LoginButton

local LTEXT = LSYS.LoadingText

local REQUIRED_USER = "1"
local REQUIRED_PASS = "REALCYYISABITCH"

local function makeDraggable(frame)
	local dragging = false
	local dragInput, mousePos, framePos

	frame.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 then
			dragging = true
			mousePos = input.Position
			framePos = frame.Position

			input.Changed:Connect(function()
				if input.UserInputState == Enum.UserInputState.End then
					dragging = false
				end
			end)
		end
	end)

	frame.InputChanged:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseMovement then
			dragInput = input
		end
	end)

	game:GetService("UserInputService").InputChanged:Connect(function(input)
		if input == dragInput and dragging then
			local delta = input.Position - mousePos
			frame.Position = UDim2.new(
				framePos.X.Scale,
				framePos.X.Offset + delta.X,
				framePos.Y.Scale,
				framePos.Y.Offset + delta.Y
			)
		end
	end)
end

LOGIN.MouseButton1Click:Connect(function()
	local enteredUser = UBOX.Text
	local enteredPass = KBOX.Text

	if enteredUser == REQUIRED_USER and enteredPass == REQUIRED_PASS then
		KSYS.Visible = false

		LSYS.Visible = true
		LTEXT.Text = "LOADING"

		wait(2)
		LTEXT.Text = "WELCOME, " .. playerUser

		wait(2)
		LTEXT.Text = "FUCK REALCYY THAT NIGGA A BITCH"

		wait(5)
		LSYS.Visible = false
		LIBRARY.Visible = true
	else
		UBOX.TextColor3 = Color3.fromRGB(255, 0, 0)
		KBOX.TextColor3 = Color3.fromRGB(255, 0, 0)

		wait(1)

		UBOX.TextColor3 = Color3.fromRGB(255, 255, 255)
		KBOX.TextColor3 = Color3.fromRGB(255, 255, 255)
	end
end)

makeDraggable(KSYS)
makeDraggable(LSYS)
makeDraggable(LIBRARY)

LOGIN.MouseButton1Click:Connect(function()
	local enteredUser = UBOX.Text
	local enteredPass = KBOX.Text

	if enteredUser == REQUIRED_USER and enteredPass == REQUIRED_PASS then
		KSYS.Visible = false

		LSYS.Visible = true
		LTEXT.Text = "LOADING"
		

		for _ = 1, 5 do
			wait(0.5)
		end

		wait(1)
		LTEXT.Text = "WELCOME, " .. playerUser
		
		wait(2)
		LTEXT.Text = "FUCK REALCYY THAT NIGGA A BITCH"

		wait(5)
		LSYS.Visible = false
		LIBRARY.Visible = true
	else
		UBOX.TextColor3 = Color3.fromRGB(255, 0, 0)
		KBOX.TextColor3 = Color3.fromRGB(255, 0, 0)

		wait(1)

		UBOX.TextColor3 = Color3.fromRGB(255, 255, 255)
		KBOX.TextColor3 = Color3.fromRGB(255, 255, 255)
	end
end)

local LUI = UI.Library
local OFFB = LUI.OFFButton
local ONB = UI.OnButton
local HP = LUI.HomePage
local OP = LUI.OtherPage
local FarmP = LUI.FarmPage
local NPCP = LUI.NPCPage

local OB = LUI.OtherButton
local HPB = LUI.HomeButton
local FarmB = LUI.FarmButton
local NPCB = LUI.NPCButton

local Pages = {
	[HPB] = HP,
	[OB] = OP,
	[FarmB] = FarmP,
	[NPCB] = NPCP
}

local ToggleButtons = {
	DistanceESP = NPCP.DistanceESP.ImageButton,
	TweenToNitty = NPCP.TweenTD.ImageButton
}

local ESPButtons = {}
local DistanceLabels = {}

local player = game.Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoidRootPart = character:WaitForChild("HumanoidRootPart")

local function resetAll()
	for button, page in pairs(Pages) do
		if button.BackTab then
			button.BackTab.BackgroundTransparency = 1
		end
		page.Visible = false
	end
end

local function togglePage(button)
	local page = Pages[button]
	if not page then return end

	if page.Visible then
		if button.BackTab then
			button.BackTab.BackgroundTransparency = 1
		end
		page.Visible = false
	else
		resetAll()
		if button.BackTab then
			button.BackTab.BackgroundTransparency = 0.5
		end
		page.Visible = true
	end
end

local function toggleESPButtonImage(button)
	if button.Image == "rbxassetid://79976764380805" then
		button.Image = "rbxassetid://81729288184303"
	else
		button.Image = "rbxassetid://79976764380805"
	end
end

local DistanceLabels = {}

local function toggleDistanceESP(enabled)
	if enabled then
		for _, nitty in ipairs(workspace.NokiaCallNPCs:GetChildren()) do
			if nitty.Name == "Nitty" and nitty:IsA("Model") and nitty:FindFirstChild("HumanoidRootPart") then
				if not nitty:FindFirstChildOfClass("BillboardGui") then
					local billboard = Instance.new("BillboardGui")
					billboard.Size = UDim2.new(0, 100, 0, 50)
					billboard.Adornee = nitty.HumanoidRootPart
					billboard.AlwaysOnTop = true
					billboard.Parent = nitty

					local textLabel = Instance.new("TextLabel")
					textLabel.Size = UDim2.new(1, 0, 1, 0)
					textLabel.BackgroundTransparency = 1
					textLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
					textLabel.TextStrokeTransparency = 0
					textLabel.TextScaled = true
					textLabel.Font = Enum.Font.GothamBold
					textLabel.Text = "0 studs"
					textLabel.Parent = billboard

					table.insert(DistanceLabels, billboard)
				end
			end
		end

		local connection
		connection = game:GetService("RunService").RenderStepped:Connect(function()
			if not enabled then
				connection:Disconnect()
				return
			end

			for _, nitty in ipairs(workspace.NokiaCallNPCs:GetChildren()) do
				if nitty.Name == "Nitty" and nitty:IsA("Model") and nitty:FindFirstChild("HumanoidRootPart") then
					local distance = (humanoidRootPart.Position - nitty.HumanoidRootPart.Position).Magnitude
					local billboard = nitty:FindFirstChildOfClass("BillboardGui")
					if billboard and billboard:FindFirstChildOfClass("TextLabel") then
						billboard.TextLabel.Text = string.format("%.1f", distance) .. " studs"
					end
				end
			end
		end)
	else
		for _, billboard in ipairs(DistanceLabels) do
			if billboard and billboard.Parent then
				billboard:Destroy()
			end
		end
		DistanceLabels = {}
	end
end


local TweenService = game:GetService("TweenService")

local function toggleTeleportToNitty(enabled)
	if enabled then
		local closestNitty = nil
		local shortestDistance = math.huge

		for _, nitty in ipairs(workspace.NokiaCallNPCs:GetChildren()) do
			if nitty.Name == "Nitty" and nitty:IsA("Model") and nitty:FindFirstChild("HumanoidRootPart") then
				local distance = (humanoidRootPart.Position - nitty.HumanoidRootPart.Position).Magnitude
				if distance < shortestDistance then
					shortestDistance = distance
					closestNitty = nitty
				end
			end
		end

		if closestNitty then
			local underMapCFrame = humanoidRootPart.CFrame + Vector3.new(0, -25, 0)
			local tweenInfoUnderMap = TweenInfo.new(2, Enum.EasingStyle.Linear, Enum.EasingDirection.Out) 
			local tweenGoalUnderMap = {CFrame = underMapCFrame}
			local tweenUnderMap = TweenService:Create(humanoidRootPart, tweenInfoUnderMap, tweenGoalUnderMap)
			tweenUnderMap:Play()

			tweenUnderMap.Completed:Wait()

			local targetCFrame = closestNitty.HumanoidRootPart.CFrame + Vector3.new(0, 2, 0)
			local tweenInfoToNitty = TweenInfo.new(30, Enum.EasingStyle.Linear, Enum.EasingDirection.Out)
			local tweenGoalToNitty = {CFrame = targetCFrame}
			local tweenToNitty = TweenService:Create(humanoidRootPart, tweenInfoToNitty, tweenGoalToNitty)
			tweenToNitty:Play()
		end
	end
end

ToggleButtons.DistanceESP.MouseButton1Click:Connect(function()
	local enabled = ToggleButtons.DistanceESP.Image == "rbxassetid://79976764380805"
	toggleESPButtonImage(ToggleButtons.DistanceESP)
	toggleDistanceESP(enabled)
end)

ToggleButtons.TweenToNitty.MouseButton1Click:Connect(function()
	local enabled = ToggleButtons.TweenToNitty.Image == "rbxassetid://79976764380805"
	toggleESPButtonImage(ToggleButtons.TweenToNitty)
	toggleTeleportToNitty(enabled)
end)

HPB.MouseButton1Click:Connect(function()
	togglePage(HPB)
end)

OB.MouseButton1Click:Connect(function()
	togglePage(OB)
end)

FarmB.MouseButton1Click:Connect(function()
	togglePage(FarmB)
end)

NPCB.MouseButton1Click:Connect(function()
	togglePage(NPCB)
end)

OFFB.MouseButton1Click:Connect(function()
	LUI.Visible = false
	ONB.Visible = true
end)

ONB.MouseButton1Click:Connect(function()
	LUI.Visible = true
	ONB.Visible = false
end)
